<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Documents - å­¦ä¸šè¾…åŠ©å¹³å°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/style.css">
    <style>
        .layout {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .main-area {
            flex: 1;
            background-color: var(--bg-color);
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        h1 {
            margin-bottom: 24px;
            font-size: 24px;
        }

        .upload-card {
            background-color: var(--input-bg);
            padding: 24px;
            border-radius: 8px;
            border: 1px dashed var(--border-color);
            text-align: center;
            margin-bottom: 32px;
        }

        .file-input {
            display: none;
        }

        .upload-label {
            display: inline-block;
            padding: 12px 24px;
            background-color: var(--primary-btn);
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .upload-label:hover {
            background-color: var(--primary-btn-hover);
        }

        .doc-list {
            display: grid;
            gap: 16px;
        }

        .doc-item {
            background-color: var(--input-bg);
            padding: 16px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-color);
        }

        .doc-item:hover {
            border-color: var(--primary-btn);
            background-color: var(--button-hover);
        }

        .doc-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .doc-icon {
            font-size: 24px;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .action-btn.delete:hover {
            background-color: #ef4444;
            border-color: #ef4444;
            color: white;
        }

        .action-btn.download:hover {
            background-color: var(--primary-btn);
            border-color: var(--primary-btn);
            color: white;
        }
    </style>
</head>
<body>

<div class="layout">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="location.href='chat.html'">
                <span>+</span> æ–°å»ºå¯¹è¯
            </button>
        </div>
        
        <div class="nav-links">
            <a href="chat.html" class="nav-item">
                <span>ğŸ’¬</span> æ™ºèƒ½é—®ç­”
            </a>
            <a href="documents.html" class="nav-item active">
                <span>ğŸ“„</span> æ–‡æ¡£åº“
            </a>
            <a href="profile.html" class="nav-item">
                <span>ğŸ‘¤</span> å­¦ä¹ ç”»åƒ
            </a>
            <a href="history.html" class="nav-item">
                <span>ğŸ•’</span> å†å²è®°å½•
            </a>
        </div>

        <div class="user-menu">
            <div class="nav-item" onclick="logout()">
                <span>ğŸšª</span> é€€å‡ºç™»å½•
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-area">
        <div class="app-topbar">
            <button class="icon-btn sidebar-toggle" id="sidebarToggle" type="button" aria-label="æ‰“å¼€ä¾§è¾¹æ ">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 6H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="topbar-title">æ–‡æ¡£åº“</div>
            <div class="topbar-spacer"></div>
            <button class="icon-btn" id="themeToggle" type="button" aria-label="åˆ‡æ¢ä¸»é¢˜">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.8A8.5 8.5 0 1 1 11.2 3a6.7 6.7 0 0 0 9.8 9.8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <div class="page-scroll">
            <div class="page-shell">
                <h1>çŸ¥è¯†åº“æ–‡æ¡£</h1>
                
                <!-- æ•™å¸ˆä¸Šä¼ åŒº -->
                <div id="uploadSection" class="upload-card" style="display: none;">
                    <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.txt">
                    <label for="fileInput" class="upload-label">
                        ä¸Šä¼ æ–‡æ¡£
                    </label>
                    <p style="margin-top: 12px; color: var(--text-secondary); font-size: 14px;">
                        æ”¯æŒæ ¼å¼: PDF, TXT, DOCX
                    </p>
                </div>

                <h3>å·²ä¸Šä¼ æ–‡æ¡£</h3>
                <div class="doc-list" id="docList">
                    <!-- Loading state -->
                    <div style="color: var(--text-secondary)">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../static/js/modal.js"></script>
<script>
    let userRole = null;
    
    // é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·ä¿¡æ¯
    async function initPage() {
        try {
            const resp = await fetch('../api/user/profile');
            const res = await resp.json();
            if (res.success && res.data) {
                userRole = res.data.role;
                // æ•™å¸ˆæ§åˆ¶
                if (userRole === 'teacher') {
                    document.getElementById('uploadSection').style.display = 'block';
                }
            }
        } catch (e) {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
        }
        loadDocuments();
    }
    
    // File Upload
    document.getElementById('fileInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        let uploadModal = null;
        try {
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦å¼¹çª—
            uploadModal = showLoading('æ­£åœ¨ä¸Šä¼ ', `æ­£åœ¨ä¸Šä¼ æ‚¨çš„æ–‡æ¡£: ${file.name}...`);
            e.target.value = ''; // Reset
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60ç§’è¶…æ—¶
            
            const resp = await fetch('../api/document/upload', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            
            const res = await resp.json();
            
            // å…³é—­loadingå¼¹çª—
            if (uploadModal) {
                window.Modal.closeModal(uploadModal);
            }
            
            if (res.success) {
                showAlert('ä¸Šä¼ æˆåŠŸ', `æ–‡æ¡£ "${file.name}" å·²æˆåŠŸåŠ å…¥AIæ–‡æ¡£åº“ï¼Œå¯ä¾›æ™ºèƒ½é—®ç­”ä½¿ç”¨`, () => {
                    loadDocuments();
                    showToast('æ–‡æ¡£å·²æ·»åŠ ', 'success', 2000);
                });
            } else {
                showAlert('ä¸Šä¼ å¤±è´¥', res.message || 'ä¸Šä¼ æ–‡æ¡£å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', null);
            }
        } catch (err) {
            if (uploadModal) {
                window.Modal.closeModal(uploadModal);
            }
            if (err.name === 'AbortError') {
                showAlert('ä¸Šä¼ è¶…æ—¶', 'æ–‡ä»¶ä¸Šä¼ è¶…è¿‡60ç§’ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é€‰æ‹©æ›´å°çš„æ–‡ä»¶', null);
            } else {
                showAlert('é”™è¯¯', 'ä¸Šä¼ å¤±è´¥ï¼š' + (err.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ä½ çš„ç½‘ç»œè¿æ¥'), null);
            }
        }
    });

    // Load Documents
    async function loadDocuments() {
        const container = document.getElementById('docList');
        try {
            const resp = await fetch('../api/document/list');
            const res = await resp.json();
            
            if (res.success && res.data.length > 0) {
                container.innerHTML = res.data.map(doc => {
                    // åªæœ‰æ•™å¸ˆæ‰èƒ½çœ‹åˆ°åˆ é™¤æŒ‰é’®
                    const deleteBtn = userRole === 'teacher' ? 
                        `<button class="action-btn delete" onclick="deleteDoc(${doc.id})">åˆ é™¤</button>` : '';
                    return `
                        <div class="doc-item">
                            <div class="doc-info">
                                <span class="doc-icon">ğŸ“„</span>
                                <div>
                                    <div>${doc.name}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary)">ID: ${doc.id}</div>
                                </div>
                            </div>
                            <div class="actions">
                                <button class="action-btn download" onclick="downloadDoc(${doc.id})">ä¸‹è½½</button>
                                ${deleteBtn}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div style="color: var(--text-secondary)">æš‚æ— æ–‡æ¡£</div>';
            }
        } catch (e) {
            container.innerHTML = '<div style="color: #ef4444">åŠ è½½æ–‡æ¡£å¤±è´¥</div>';
        }
    }

    // Download
    function downloadDoc(id) {
        const downloadModal = showLoading('æ­£åœ¨ä¸‹è½½', 'æ­£åœ¨æ‰“åŒ…æ‚¨çš„æ–‡æ¡£...');
        // æ¨¡æ‹Ÿä¸‹è½½ä»½é¢å¤„ç†ï¼Œå®é™…ä¸Šä¸‹è½½æ˜¯ç«‹å³çš„
        setTimeout(() => {
            window.Modal.closeModal(downloadModal);
            window.open(`../api/document/download/${id}`, '_blank');
            showToast('ä¸‹è½½å·²å¼€å§‹', 'success', 2000);
        }, 500);
    }

    // Delete
    async function deleteDoc(id) {
        showDeleteConfirm(
            'åˆ é™¤æ–‡æ¡£',
            'ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¯¥æ–‡æ¡£å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚',
            async () => {
                const deleteModal = showLoading('æ­£åœ¨åˆ é™¤', 'æ­£åœ¨åˆ é™¤æ–‡æ¡£...');
                try {
                    const resp = await fetch(`../api/document/${id}`, { method: 'DELETE' });
                    const res = await resp.json();
                    window.Modal.closeModal(deleteModal);
                    if (res.success) {
                        showAlert('åˆ é™¤æˆåŠŸ', 'æ–‡æ¡£å·²æˆåŠŸåˆ é™¤', () => {
                            loadDocuments();
                        showToast('æ–‡æ¡£åº“å·²æ›´æ–°', 'info', 2000);
                        });
                    } else {
                        showAlert('åˆ é™¤å¤±è´¥', res.message || 'åˆ é™¤æ–‡æ¡£å¤±è´¥', null);
                    }
                } catch (e) {
                    window.Modal.closeModal(deleteModal);
                    showAlert('é”™è¯¯', 'åˆ é™¤æ–‡æ¡£å¤±è´¥', null);
                }
            },
            null
        );
    }

    async function logout() {
        showConfirm(
            'ç¡®è®¤é€€å‡º',
            'æ‚¨ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
            async () => {
                const logoutModal = showLoading('æ­£åœ¨é€€å‡º', 'æ­£åœ¨ä¸‹çº¿...');
                await fetch('../api/user/logout', { method: 'POST' });
                window.Modal.closeModal(logoutModal);
                showToast('é€€å‡ºæˆåŠŸ', 'success', 1500);
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 300);
            },
            null
        );
    }

    // Initial load
    initPage();

    (function () {
        try {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.dataset.theme = 'dark';
            }
        } catch (e) {
        }

        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', function () {
                const isDark = document.body.dataset.theme === 'dark';
                if (isDark) {
                    delete document.body.dataset.theme;
                    try {
                        localStorage.setItem('theme', 'light');
                    } catch (e) {
                    }
                } else {
                    document.body.dataset.theme = 'dark';
                    try {
                        localStorage.setItem('theme', 'dark');
                    } catch (e) {
                    }
                }
            });
        }

        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function () {
                document.body.classList.toggle('sidebar-open');
            });
        }

        document.addEventListener('click', function (e) {
            if (window.innerWidth > 920) {
                return;
            }
            const sidebar = document.querySelector('.sidebar');
            if (!sidebar) {
                return;
            }
            if (sidebar.contains(e.target) || (sidebarToggle && sidebarToggle.contains(e.target))) {
                return;
            }
            document.body.classList.remove('sidebar-open');
        });
    })();
</script>
<script src="../static/js/immersive-float.js"></script>
</body>
</html>
