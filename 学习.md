# 学业辅助平台（SSM + AI + 文档知识库）项目总结

## 1. 项目概述

本项目是一个基于 SSM（Spring / Spring MVC / MyBatis）架构的学业辅助平台，核心能力包括：

- 用户登录与角色权限（学生/教师/管理员）
- AI 智能问答（对接兼容 OpenAI 协议的对话接口）
- 文档库上传与解析（PDF/DOC/DOCX/TXT）
- 文档切片入库 + 关键词检索式 RAG（按需触发）
- 对话会话与消息历史（可回看、可切换）
- 学习画像：提问主题归类与可视化层次结构数据
- 前端页面统一为类 ChatGPT 风格，支持深色模式与等待动效

## 2. 技术栈与运行环境

### 2.1 后端

- Java 17
- Spring Framework 5.3.x
- Spring MVC
- MyBatis + XML Mapper
- Jackson（JSON 序列化/反序列化）
- MySQL 8.x（数据持久化）
- Jetty Maven Plugin（本地开发启动，默认端口 8081）
- 文档解析：Apache PDFBox + Apache POI（DOC/DOCX）
- Redis：依赖与连接工厂已配置（当前业务逻辑不强依赖，可用于扩展会话/上下文缓存）

### 2.2 前端

- HTML5 + CSS3（Flex 布局、变量主题、响应式）
- 原生 JavaScript（Fetch API）
- D3 v7（学习画像可视化页面使用外链脚本）

## 3. 角色与权限设计

| 角色 | 主要能力 |
| --- | --- |
| student | 登录、AI 问答、查看历史记录、查看学习画像、下载文档 |
| teacher | 具备 student 能力 + 上传/删除文档，维护知识库 |
| admin | 管理后台页面入口（当前为骨架页，可按需扩展管理功能） |

当前已落地的硬权限点：

- 文档上传：仅教师（`DocumentController.upload`）
- 文档删除：仅教师（`DocumentController.delete`）

## 4. 代码与目录结构

```text
src/main/java/com/xxzd/study
├── ai/                     # AI 调用客户端（HTTP）
├── common/                 # 通用返回结构 ApiResponse 等
├── config/                 # 数据库初始化等组件
├── controller/             # REST API 控制器
├── domain/                 # 实体对象
├── mapper/                 # MyBatis Mapper 接口
└── service/impl/           # 业务实现（聊天、文档、画像）

src/main/resources
├── applicationContext.xml  # Spring 根容器、数据源、事务、AI 客户端 Bean
├── spring-mvc.xml          # MVC 配置
├── mybatis-config.xml      # MyBatis 配置
├── db.properties           # MySQL 连接
├── redis.properties        # Redis 与 AI 接口配置（包含 ai.api.url / ai.api.key）
├── mappers/                # MyBatis XML
└── sql/                    # schema.sql / migration.sql

src/main/webapp
├── pages/                  # login/chat/documents/history/profile/admin
└── static/                 # css/js 资源
```

## 5. 核心功能实现总结

### 5.1 登录与会话

- 登录接口：`POST /api/user/login`（成功后将 `currentUser` 存入 HttpSession）
- 退出接口：`POST /api/user/logout`
- 当前用户：`GET /api/user/profile`

### 5.2 AI 问答与会话历史

关键接口：

- 提问：`POST /api/chat/ask`
- 新建会话：`POST /api/chat/new`
- 会话列表：`GET /api/chat/sessions`
- 会话消息：`GET /api/chat/messages/{sessionId}`
- 最近会话：`GET /api/chat/latest`

核心流程（一次提问）：

1. 前端发起 `POST /api/chat/ask`，带 `question` 与可选 `sessionId`
2. 后端调用 `ChatServiceImpl.getAiAnswer` 获取 AI 回复
3. 根据用户与 `sessionId` 创建/复用会话 `chat_session`
4. 写入两条消息记录：`user`、`ai` 到 `chat_message`
5. 记录提问日志用于画像分析（`LearningProfileService.recordQuestion`）

### 5.3 文档库与知识库入库

关键接口：

- 上传：`POST /api/document/upload`（MultipartFile）
- 列表：`GET /api/document/list`
- 下载：`GET /api/document/download/{id}`
- 删除：`DELETE /api/document/{id}`

上传与入库流程（教师端）：

1. 创建 `document` 记录（保存原始文件名）
2. 将文件保存到本机目录：`%USERPROFILE%\\study-ai-uploads\\`
3. 更新 `document.stored_filename`，用于下载与重建关联
4. 解析文本（PDFBox/POI），按固定策略切片并写入 `document_chunk`

### 5.4 RAG（按需触发 + 关键词检索）

本项目当前的 RAG 是“文档切片 + SQL 关键词检索 + 提示词拼接”的方式：

- 关键词抽取：`ChatServiceImpl.extractKeywords`
- 切片检索：`DocumentChunkMapper.selectByKeywordsLike`（`content LIKE '%kw%'`）
- 片段拼接：构造 `[资料1] ...` 的知识库资料段落

触发策略（已做“缓和”处理）：

- 只有当用户问题中包含明显“文档/资料/知识库/文件”等提示词时，才会触发知识库检索与 RAG 提示
- 普通学科问答（未提及文档）走普通对话，不强绑定知识库

约束策略（防胡说但不过度僵硬）：

- 检索到资料时：要求在回答中引用资料；若未出现引用标记会触发一次重试
- 未检索到资料时：允许输出通用解释/学习建议，但明确标注“通用补充”，引用为“无”

备注：

- `document_embedding` 表已在 `schema.sql` 预留，目前业务未使用向量检索；后续可升级为“向量召回 + 关键词重排”。

### 5.5 学习画像与可视化

关键接口：

- 当前画像：`GET /api/profile/current`
- 层次数据：`GET /api/profile/hierarchy`

实现思路：

- `LearningProfileServiceImpl.recordQuestion` 在每次提问后写入 `user_question_log`
- `buildProfile/buildHierarchy` 根据日志生成画像摘要与可视化所需结构
- 前端 `profile.html` 使用 D3 展示层次结构图（并提供沉浸模式/交互）

## 6. 数据库设计摘要

核心表（见 `src/main/resources/sql/schema.sql`）：

- 用户：`user`
- 文档：`document`（含 `stored_filename` 关联磁盘文件）
- 文档切片：`document_chunk`
- 对话会话/消息：`chat_session`、`chat_message`
- 学习画像：`user_question_log`、`learning_profile`
- 预留/扩展：`document_embedding`、`ai_feedback`、`prompt_template`、`notice`、`user_notice`

数据库启动自检：

- `DatabaseInitializer` 会在启动时检查 `document` 表是否存在 `stored_filename` 列，不存在则自动补齐。

## 7. 前端页面与交互总结

页面入口（`src/main/webapp/pages`）：

- `login.html`：登录
- `chat.html`：智能问答（类 ChatGPT 布局、深色模式、输入框自适应高度、AI 思考动效、发送态禁用避免重复请求）
- `documents.html`：文档库（教师上传区、列表、下载、删除）
- `history.html`：历史记录（左侧会话列表 + 右侧消息预览）
- `profile.html`：学习画像（D3 可视化、沉浸模式）
- `admin.html`：管理后台（骨架页）

关键交互与稳定性处理：

- 聊天消息渲染使用 `textContent`，避免 HTML 注入与显示异常
- AI 等待时展示“正在思考”动效，并禁用输入与发送按钮
- 移动端支持侧边栏抽屉打开/关闭
- 全站统一主题变量，支持深色模式切换与持久化

## 8. 本地运行与配置说明（Windows）

### 8.1 数据库准备

1. 创建数据库：`study_ai`
2. 执行 `src/main/resources/sql/schema.sql`
3. 配置 `src/main/resources/db.properties`（默认账号 `root`、密码 `1234`）

### 8.2 AI 接口配置

在 `src/main/resources/redis.properties` 中配置：

- `ai.api.url`
- `ai.api.key`

注意：`ai.api.key` 属于敏感信息，建议仅在本机环境保管，避免泄露。

### 8.3 启动项目

使用 Maven 启动：

```bash
mvn jetty:run
```

访问地址：

- `http://localhost:8081/ssm-spring-ai-study/pages/login.html`
- `http://localhost:8081/ssm-spring-ai-study/pages/chat.html`

## 9. 关键问题与优化记录（项目迭代成果）

- 聊天消息显示与滚动：修复消息渲染与底部遮挡问题
- 文档入库链路：补齐 `stored_filename` 与重建切片流程，确保上传文档可用于检索
- RAG 可靠性：增加引用约束与不合规重试，减少“看似回答但无依据”的情况
- RAG 体验：将 RAG 触发改为“按需触发”，避免对普通问题过度依赖文档
- 导航与布局：统一为类 ChatGPT 的侧边栏/顶栏布局，支持响应式与主题切换
- 等待动效：AI 生成期间展示“思考中”动画，避免用户等待单调

## 10. 后续可扩展方向

- 向量检索：为 `document_chunk` 生成 embedding，结合 `document_embedding` 实现更强的召回
- 检索排序：关键词命中计数、BM25、分段去重与来源聚合
- 权限完善：管理员功能落地（公告、用户管理、Prompt 管理）
- 安全与配置：敏感配置外置（环境变量/本机配置文件），降低泄露风险
- 性能：大文档解析异步化、切片批量入库优化、缓存策略完善
